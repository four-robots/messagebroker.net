# NATS Bindings - Native Go Library

This directory contains the Go source code for the native NATS server bindings used by MessageBroker.NET. The bindings provide a P/Invoke interface from C# to the embedded NATS server.

## Overview

The NATS bindings are built as a C-shared library that exposes the NATS server functionality to .NET through Platform Invoke (P/Invoke). This allows MessageBroker.NET to control an embedded NATS server instance directly from C# code.

## Architecture

```
C# (.NET) → P/Invoke → C-shared Library (Go) → NATS Server (Go)
```

### Exposed Functions

The following functions are exported via cgo and available to C#:

1. **StartServer** - Start NATS server with JSON configuration
2. **StartServerWithJetStream** - Start server with JetStream enabled
3. **StartServerFromConfigFile** - Start server from NATS config file
4. **ShutdownServer** - Gracefully shutdown the server
5. **GetClientURL** - Get the client connection URL
6. **GetServerInfo** - Get detailed server information as JSON
7. **FreeString** - Free C strings allocated by Go
8. **ReloadConfig** - Hot reload the current configuration
9. **ReloadConfigFromFile** - Reload configuration from file
10. **UpdateAndReloadConfig** - Update config from JSON and reload
11. **CreateAccount** - Create a NATS account (basic)
12. **CreateAccountWithJWT** - Create account with JWT credentials

## Building

### Prerequisites

- **Go 1.21 or later** - [Download Go](https://golang.org/dl/)
- **GCC** (for cgo) - Usually pre-installed on Linux, install via MinGW or TDM-GCC on Windows
- **.NET 9.0 SDK** - For testing the integration

### Quick Build

#### Linux/macOS
```bash
cd native
chmod +x build.sh
./build.sh
```

This will:
1. Download Go dependencies
2. Build `nats-bindings.so`
3. Copy to .NET output directories

#### Windows
```powershell
cd native
.\build.ps1
```

This will:
1. Download Go dependencies
2. Build `nats-bindings.dll`
3. Copy to .NET output directories

### Cross-Platform Build

To build for both platforms (requires cross-compilation setup):

```bash
chmod +x build-all.sh
./build-all.sh
```

**Note:** Cross-compilation from Linux to Windows requires:
```bash
sudo apt-get install gcc-mingw-w64  # Ubuntu/Debian
```

### Manual Build

If you prefer to build manually:

```bash
# Download dependencies
go mod download
go mod tidy

# Linux/macOS
go build -buildmode=c-shared -o nats-bindings.so nats-bindings.go

# Windows
go build -buildmode=c-shared -o nats-bindings.dll nats-bindings.go
```

## Dependencies

The bindings use the following Go packages:

- **github.com/nats-io/nats-server/v2** (v2.11.0) - NATS server implementation
- **github.com/nats-io/jwt/v2** (v2.7.3) - JWT credential support
- **github.com/nats-io/nkeys** (v0.4.9) - NATS cryptographic keys

All dependencies are managed via `go.mod` and automatically downloaded during build.

## Project Structure

```
native/
├── nats-bindings.go      # Main cgo bindings implementation
├── go.mod                # Go module definition
├── go.sum                # Dependency checksums (auto-generated)
├── build.sh              # Linux/macOS build script
├── build.ps1             # Windows build script
├── build-all.sh          # Cross-platform build script
├── README.md             # This file
├── nats-bindings.so      # Linux shared library (generated)
├── nats-bindings.dll     # Windows DLL (generated)
└── nats-bindings.h       # C header file (auto-generated by cgo)
```

## Development Workflow

### 1. Modify the Go Code

Edit `nats-bindings.go` to add new functions or change behavior.

### 2. Update C# Bindings

If you add new exported functions, update the P/Invoke declarations in:
- `src/MessageBroker.Nats/Bindings/NatsBindings.cs`

Add the `[DllImport]` declarations for both `WindowsNatsBindings` and `LinuxNatsBindings`.

### 3. Rebuild

```bash
# Run the appropriate build script
./build.sh      # Linux/macOS
# or
.\build.ps1     # Windows
```

### 4. Test

```bash
cd ../src/MessageBroker.Examples
dotnet run -- test
```

### 5. Update Documentation

Update the API documentation in `docs/` if you've changed the interface.

## Upgrading NATS Server Version

To upgrade to a newer version of NATS server:

1. Edit `go.mod` and update the version:
   ```go
   require (
       github.com/nats-io/nats-server/v2 v2.11.0  // Change this version
   )
   ```

2. Download the new version:
   ```bash
   go get github.com/nats-io/nats-server/v2@v2.11.0
   go mod tidy
   ```

3. Review [NATS Server Release Notes](https://github.com/nats-io/nats-server/releases) for breaking changes

4. Test thoroughly:
   ```bash
   ./build.sh
   cd ../src/MessageBroker.Examples
   dotnet run -- test
   ```

5. Update version references in:
   - `CLAUDE.md`
   - `README.md`
   - `docs/ARCHITECTURE.md`

## Memory Management

The bindings use C strings for communication between C# and Go:

- **Go → C#**: Go allocates strings with `C.CString()`, C# must call `FreeString()` to release them
- **C# → Go**: C# passes strings, Go converts with `C.GoString()` (creates Go-managed copy)

The `FreeString()` function is critical for preventing memory leaks. The C# code in `NatsController` properly handles this.

## Thread Safety

The bindings use a `sync.Mutex` to protect the global `natsServer` instance, ensuring thread-safe access from multiple C# threads.

## Error Handling

Functions return C strings with the following formats:
- **Success**: `"OK"` or JSON data
- **Error**: `"ERROR: <message>"`

The C# code parses these responses and throws appropriate exceptions.

## Troubleshooting

### Build Errors

**"go: cannot find main module"**
- Make sure you're in the `native/` directory
- Run `go mod init` if `go.mod` is missing

**"undefined: server.Server"**
- Run `go mod download` to fetch dependencies
- Run `go mod tidy` to clean up dependencies

**"gcc not found"** (Windows)
- Install TDM-GCC or MinGW-w64
- Add to PATH environment variable

### Runtime Errors

**"Unable to load DLL 'nats-bindings.dll'"** (Windows)
- Ensure `nats-bindings.dll` is in the same directory as your .exe
- Run the build script to copy it to output directories
- Check that you have the Visual C++ Redistributable installed

**"Unable to load shared library 'nats-bindings.so'"** (Linux)
- Ensure `nats-bindings.so` is in the same directory as your executable
- Check with `ldd nats-bindings.so` for missing dependencies
- Set `LD_LIBRARY_PATH` if needed: `export LD_LIBRARY_PATH=.:$LD_LIBRARY_PATH`

**Server fails to start**
- Check port availability (default 4222)
- Review NATS logs (enable with `Debug: true` in config)
- Ensure JetStream store directory is writable

## Integration with .NET Build

To automatically rebuild the bindings during .NET builds, add a pre-build event to your `.csproj`:

### Linux/macOS
```xml
<Target Name="BuildNativeBindings" BeforeTargets="PreBuildEvent">
  <Exec Command="cd $(ProjectDir)../../native &amp;&amp; ./build.sh" />
</Target>
```

### Windows
```xml
<Target Name="BuildNativeBindings" BeforeTargets="PreBuildEvent">
  <Exec Command="cd $(ProjectDir)..\..\native &amp;&amp; powershell -ExecutionPolicy Bypass -File build.ps1" />
</Target>
```

## Performance Notes

- **Server startup**: Typically 50-200ms depending on JetStream enablement
- **Hot reload**: 5-20ms for configuration updates
- **Memory overhead**: ~10-30 MB for base server, more with JetStream
- **P/Invoke overhead**: Negligible (<1ms per call)

## Security Considerations

- The bindings run the NATS server in-process with the .NET application
- Authentication credentials are passed through the bindings
- TLS configuration is supported through NATS server options
- For production, always use authentication and consider TLS

## Contributing

When contributing to the native bindings:

1. Follow Go best practices and formatting (`gofmt`)
2. Update both Windows and Linux build scripts
3. Test on both platforms if possible
4. Update this README with any new functions or requirements
5. Run the automated tests before submitting

## Resources

- [NATS Server Documentation](https://docs.nats.io/running-a-nats-service/introduction)
- [NATS Server GitHub](https://github.com/nats-io/nats-server)
- [cgo Documentation](https://golang.org/cmd/cgo/)
- [MessageBroker.NET Documentation](../docs/INDEX.md)

## Version Information

- **NATS Server**: v2.11.0
- **Go Version**: 1.21+
- **Target Platforms**: Linux (amd64), Windows (amd64)
- **Last Updated**: November 2024
